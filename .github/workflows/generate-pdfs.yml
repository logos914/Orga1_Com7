name: Generate PDFs

on:
  push:
    branches:
      - main
    paths:
      - '**.md'
      - 'themes/**'
      - '.github/workflows/generate-pdfs.yml'

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgbm-dev gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget
          npm ci
          
      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli
        
      - name: Create output directory
        run: mkdir -p dist/pdf
        
      - name: Generate PDFs
        run: |
          find . -name "*.md" -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/\.*" | while read -r file; do
            output_dir="dist/pdf/$(dirname "$file" | sed 's/^\.\///')"
            mkdir -p "$output_dir"
            filename=$(basename "$file" .md)
            echo "Converting $file to PDF..."
            marp --pdf --allow-local-files --theme-set ./themes/ "$file" -o "$output_dir/$filename.pdf"
          done
          
      - name: Upload PDFs as artifacts
        uses: actions/upload-artifact@v3
        with:
          name: slide-pdfs
          path: dist/pdf
          
      - name: Create PDF directory in repository
        run: |
          mkdir -p pdf
          cp -r dist/pdf/* pdf/
          
      - name: Commit and push PDFs
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Actualizar PDFs generados [skip ci]"
          file_pattern: pdf/**/*.pdf